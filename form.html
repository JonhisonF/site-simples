<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Formulário de Captação de Dados</title>
    <link rel="stylesheet" href="css/style.css"/>
    <style>
        main {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
        }

        h1 {
            background-color: #333;
            color: #fff;
            padding: 20px 10px;
        }

        .card {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, .08);
            padding: 16px;
            width: min(100%, 820px);
        }

        label {
            display: block;
            font-weight: bold;
            margin-top: 10px;
        }

        input {
            width: 100%;
            padding: 10px 12px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        input[type="submit"],
        .btn {
            background-color: #333;
            color: #fff;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        input[type="submit"]:hover, .btn:hover {
            background-color: #555;
        }

        .error-message {
            color: red;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }

        @media (min-width: 840px) {
            .grid {
                grid-template-columns: 1fr 280px;
            }
        }

        .panel {
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 12px;
        }

        .toolbar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .toolbar input[type="search"] {
            flex: 1;
            min-width: 180px;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 8px 10px;
        }

        .table-wrap {
            overflow: auto;
            border: 1px solid #eee;
            border-radius: 8px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            min-width: 520px;
        }

        th, td {
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
            text-align: left;
        }

        th {
            background: #f8f8f8;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        tr:hover td {
            background: #fcfcfc;
        }

        .stats {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .stat {
            background: #f6f6f6;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px 12px;
            min-width: 160px;
        }

        .muted {
            color: #777;
            font-size: .9rem;
        }

        .pill {
            display: inline-block;
            padding: 4px 8px;
            font-size: .8rem;
            border: 1px solid #ddd;
            border-radius: 999px;
            background: #f9f9f9;
        }

        footer p {
            text-align: center;
        }

        small.hint {
            color: #777;
        }
    </style>
  </head>
  <body>
    <header>
      <nav>
        <ul>
          <li><a href="index.html">Inicio</a></li>
          <li><a href="form.html">Envio de dados</a></li>
          <li><a href="about.html">Sobre</a></li>
        </ul>
      </nav>
    </header>

    <main>
      <div class="card">
        <h1>Formulário de Captação de Dados</h1>

        <div class="grid">
          <div>
            <form id="formulario" action="formAction.html" method="get">
              <label for="nome">Nome: <small class="hint">(máx. 80)</small></label>
              <input type="text" id="nome" name="nome" maxlength="80" required/>
              <small id="nome-count" class="muted">0/80</small>
              <br/>

              <label for="email">E-mail:</label>
              <input type="email" id="email" name="email" required/>
              <br/>

              <label for="idade">Idade:</label>
              <input type="number" id="idade" name="idade" min="0" max="120" required/>
              <span class="error-message" id="idade-error"></span>
              <br/>

              <input type="submit" value="Enviar"/>
            </form>
          </div>

          <aside class="panel">
            <strong>Prévia do Envio</strong>
            <div class="muted" style="margin:6px 0 10px;">URL (GET) gerada automaticamente</div>
            <code id="preview-url"
                  style="display:block; white-space:break-spaces; word-break:break-word; border:1px solid #eee; background:#fff; padding:8px; border-radius:6px;">
              formAction.html
            </code>
            <hr/>
            <div>
              <strong>Dicas</strong>
              <ul class="muted" style="padding-left:16px; margin:6px 0;">
                <li>Use seu e-mail real pra testes.</li>
                <li>Idade entre 0 e 120.</li>
                <li>Os envios ficam salvos localmente.</li>
              </ul>
              <span class="pill">LocalStorage</span>
            </div>
          </aside>
        </div>
      </div>

      <section class="card" aria-labelledby="lista-titulo">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px;">
          <h2 id="lista-titulo" style="margin:0;">Registros Locais</h2>
          <span class="muted">dados salvos no seu navegador</span>
        </div>

        <div class="toolbar" style="margin: 10px 0 12px;">
          <input type="search" id="busca" placeholder="Buscar por nome ou e-mail..."/>
          <button class="btn" id="export-json">Exportar JSON</button>
          <button class="btn" id="export-csv">Exportar CSV</button>
          <button class="btn" id="seed">Adicionar exemplo</button>
          <button class="btn" id="limpar">Limpar lista</button>
        </div>

        <div class="stats" style="margin-bottom:12px;">
          <div class="stat">
            <div class="muted">Total</div>
            <strong id="stat-total">0</strong></div>
          <div class="stat">
            <div class="muted">Média de idade</div>
            <strong id="stat-media">—</strong></div>
        </div>

        <div class="table-wrap">
          <table id="tabela">
            <thead>
            <tr>
              <th data-sort="nome">Nome ▲▼</th>
              <th data-sort="email">E-mail ▲▼</th>
              <th data-sort="idade">Idade ▲▼</th>
              <th data-sort="data">Data ▲▼</th>
              <th>Ações</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <footer>
      <p>&copy; <span id="ano"></span> Desenvolvimento da Página Web</p>
    </footer>

    <script src="scripts/validarFormulario.js"></script>

    <script>
        (function () {
            const form = document.getElementById('formulario');
            const nome = document.getElementById('nome');
            const email = document.getElementById('email');
            const idade = document.getElementById('idade');
            const urlPrev = document.getElementById('preview-url');
            const ano = document.getElementById('ano');
            const count = document.getElementById('nome-count');

            const busca = document.getElementById('busca');
            const tabela = document.getElementById('tabela').querySelector('tbody');

            const statTotal = document.getElementById('stat-total');
            const statMedia = document.getElementById('stat-media');

            const btnJSON = document.getElementById('export-json');
            const btnCSV = document.getElementById('export-csv');
            const btnSeed = document.getElementById('seed');
            const btnLimpar = document.getElementById('limpar');

            const STORAGE_KEY = 'cadastros';

            ano.textContent = new Date().getFullYear().toString();

            function updateNameCount() {
                count.textContent = (nome.value?.length || 0) + '/80';
            }

            nome.addEventListener('input', updateNameCount);
            updateNameCount();

            function updatePreview() {
                const params = new URLSearchParams();
                if (nome.value) params.set('nome', nome.value);
                if (email.value) params.set('email', email.value);
                if (idade.value) params.set('idade', idade.value);
                urlPrev.textContent = 'formAction.html' + (params.toString() ? '?' + params.toString() : '');
            }

            ['input', 'change'].forEach(evt => {
                nome.addEventListener(evt, updatePreview);
                email.addEventListener(evt, updatePreview);
                idade.addEventListener(evt, updatePreview);
            });
            updatePreview();

            const load = () => JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const save = (arr) => localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));

            let sortKey = 'data';
            let sortDir = 'desc';
            let filtro = '';

            function render() {
                const all = load();

                const filtered = all.filter(r => {
                    const texto = (r.nome + ' ' + r.email).toLowerCase();
                    return texto.includes(filtro.toLowerCase());
                });

                filtered.sort((a, b) => {
                    let vA = a[sortKey], vB = b[sortKey];
                    if (sortKey === 'data') {
                        vA = new Date(vA).getTime();
                        vB = new Date(vB).getTime();
                    }
                    if (sortKey === 'idade') {
                        vA = Number(vA);
                        vB = Number(vB);
                    }
                    if (typeof vA === 'string') vA = vA.toLowerCase();
                    if (typeof vB === 'string') vB = vB.toLowerCase();
                    if (vA < vB) return sortDir === 'asc' ? -1 : 1;
                    if (vA > vB) return sortDir === 'asc' ? 1 : -1;
                    return 0;
                });

                tabela.innerHTML = filtered.map((r, idx) => `
                <tr>
                  <td>${escapeHtml(r.nome)}</td>
                  <td>${escapeHtml(r.email)}</td>
                  <td>${r.idade}</td>
                  <td>${formatDate(r.data)}</td>
                  <td>
                    <button class="btn" data-action="remover" data-id="${r.id}">Remover</button>
                  </td>
                </tr>
              `).join('');

                statTotal.textContent = filtered.length;
                if (filtered.length) {
                    statMedia.textContent = (filtered.reduce((s, r) => s + Number(r.idade || 0), 0) / filtered.length).toFixed(1);
                } else {
                    statMedia.textContent = '—';
                }
            }

            function escapeHtml(str = '') {
                return String(str).replace(/[&<>"']/g, s => ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[s]));
            }

            function formatDate(iso) {
                const d = new Date(iso);
                const pad = (n) => String(n).padStart(2, '0');
                return `${pad(d.getDate())}/${pad(d.getMonth() + 1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
            }

            document.querySelectorAll('th[data-sort]').forEach(th => {
                th.addEventListener('click', () => {
                    const key = th.getAttribute('data-sort');
                    if (sortKey === key) {
                        sortDir = sortDir === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortKey = key;
                        sortDir = 'asc';
                    }
                    render();
                });
            });

            busca.addEventListener('input', () => {
                filtro = busca.value;
                render();
            });

            btnJSON.addEventListener('click', () => {
                const blob = new Blob([JSON.stringify(load(), null, 2)], {type: 'application/json'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'cadastros.json';
                a.click();
                URL.revokeObjectURL(a.href);
            });

            btnCSV.addEventListener('click', () => {
                const data = load();
                const header = ['id', 'nome', 'email', 'idade', 'data'];
                const rows = data.map(r => [r.id, r.nome, r.email, r.idade, r.data]);
                const csv = [header, ...rows].map(line => line.map(val => `"${String(val).replace(/"/g, '""')}"`).join(',')).join('\n');
                const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'cadastros.csv';
                a.click();
                URL.revokeObjectURL(a.href);
            });

            btnSeed.addEventListener('click', () => {
                const now = new Date().toISOString();
                const exemplo = [
                    {id: cryptoRandom(), nome: 'Maria Souza', email: 'maria@exemplo.com', idade: 28, data: now},
                    {id: cryptoRandom(), nome: 'João Silva', email: 'joao@exemplo.com', idade: 34, data: now}
                ];
                const arr = load().concat(exemplo);
                save(arr);
                render();
            });

            btnLimpar.addEventListener('click', () => {
                if (confirm('Apagar todos os registros locais?')) {
                    localStorage.removeItem(STORAGE_KEY);
                    render();
                }
            });

            document.getElementById('tabela').addEventListener('click', (e) => {
                const btn = e.target.closest('button[data-action="remover"]');
                if (!btn) return;
                const id = btn.getAttribute('data-id');
                const arr = load().filter(r => r.id !== id);
                save(arr);
                render();
            });

            form.addEventListener('submit', () => {
                try {
                    const registro = {
                        id: cryptoRandom(),
                        nome: nome.value.trim(),
                        email: email.value.trim(),
                        idade: Number(idade.value),
                        data: new Date().toISOString()
                    };
                    const arr = load();
                    arr.push(registro);
                    save(arr);
                    render();
                } catch (e) {
                }
            });

            function cryptoRandom() {
                if (window.crypto?.getRandomValues) {
                    const buf = new Uint32Array(2);
                    crypto.getRandomValues(buf);
                    return [...buf].map(n => n.toString(16)).join('');
                }
                return String(Math.random()).slice(2);
            }

            render();
        })();
    </script>
  </body>
</html>
